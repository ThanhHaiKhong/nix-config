#!/bin/bash
#
# swift-lint - Swift Code Linter Wrapper
#
# DESCRIPTION:
#   Lints Swift code with SwiftLint.
#   Auto-detects .swiftlint.yml configuration files.
#   Supports auto-fixing violations and multiple output formats.
#
# USAGE:
#   swift-lint [PATH] [OPTIONS]
#
# ARGUMENTS:
#   PATH                  Path to project directory (optional)
#
# OPTIONS:
#   --fix                 Automatically fix violations
#   --strict              Treat warnings as errors
#   --only-rule RULE      Lint only specific rule
#   --reporter TYPE       Output format (xcode|json|csv|checkstyle|etc.)
#   --config PATH         Custom configuration file path
#   --quiet, -q           Only show errors
#   --verbose, -v         Show detailed output
#
# EXAMPLES:
#   swift-lint
#   swift-lint --fix
#   swift-lint --only-rule force_cast
#   swift-lint --reporter json
#
# REQUIREMENTS:
#   - SwiftLint must be installed (brew install swiftlint)
#
# AUTHOR:
#   Swift development tooling
#

set -e  # Exit on error

# ANSI color codes for terminal output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'  # No Color (reset)

# Helper functions for colored output
print_error() {
    echo -e "${RED}❌ $1${NC}"
}

print_success() {
    echo -e "${GREEN}✅ $1${NC}"
}

print_info() {
    echo -e "${YELLOW}ℹ️  $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}⚠️  $1${NC}"
}

# Usage documentation
show_usage() {
    cat << EOF
Usage: swift-lint [PATH] [OPTIONS]

Lint Swift code with SwiftLint.

Arguments:
    PATH                  Optional path to project directory [default: current directory]

Options:
    --fix                 Automatically fix violations
    --strict              Treat warnings as errors
    --only-rule RULE      Lint only specific rule
    --reporter TYPE       Output format (xcode|json|csv|checkstyle|codeclimate|junit|html|emoji|sonarqube|markdown|github-actions-logging) [default: xcode]
    --config PATH         Custom configuration file path
    --quiet, -q           Only show errors
    --verbose, -v         Show detailed output
    --git-diff            Lint only files changed in git (uncommitted changes)
    --staged              Lint only staged files in git
    --stats               Show statistics after linting
    --files PATTERN       Lint specific files matching pattern (e.g., "*.swift")
    --help, -h            Show this help

Examples:
    swift-lint                               # Lint current directory
    swift-lint ~/Projects/MyApp              # Lint specific project
    swift-lint --fix                         # Auto-fix violations
    swift-lint --strict                      # Treat warnings as errors
    swift-lint --only-rule force_cast        # Check specific rule
    swift-lint --reporter json               # JSON output
    swift-lint ~/MyApp --fix --quiet         # Fix quietly
    swift-lint --git-diff                    # Lint only uncommitted changes
    swift-lint --staged                      # Lint only staged files
    swift-lint --stats                       # Show detailed statistics
    swift-lint --stats --fix                 # Fix with statistics

Notes:
    - Requires SwiftLint to be installed
    - Auto-detects .swiftlint.yml configuration
    - Works from any subdirectory within a project

EOF
    exit 1
}

# Default values
FIX=false
STRICT=false
ONLY_RULE=""
REPORTER="xcode"
CONFIG=""
QUIET=false
VERBOSE=false
PROJECT_PATH=""
GIT_DIFF=false
STAGED_ONLY=false
SHOW_STATS=false
FILES_PATTERN=""

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --fix)
            FIX=true
            shift
            ;;
        --strict)
            STRICT=true
            shift
            ;;
        --only-rule)
            ONLY_RULE="$2"
            shift 2
            ;;
        --reporter)
            REPORTER="$2"
            shift 2
            ;;
        --config)
            CONFIG="$2"
            shift 2
            ;;
        --quiet|-q)
            QUIET=true
            shift
            ;;
        --verbose|-v)
            VERBOSE=true
            shift
            ;;
        --git-diff)
            GIT_DIFF=true
            shift
            ;;
        --staged)
            STAGED_ONLY=true
            shift
            ;;
        --stats)
            SHOW_STATS=true
            shift
            ;;
        --files)
            FILES_PATTERN="$2"
            shift 2
            ;;
        --help|-h)
            show_usage
            ;;
        -*)
            print_error "Unknown option: $1"
            show_usage
            ;;
        *)
            # Positional argument - treat as project path
            if [[ -z "$PROJECT_PATH" ]]; then
                PROJECT_PATH="$1"
            else
                print_error "Multiple paths specified: $PROJECT_PATH and $1"
                show_usage
            fi
            shift
            ;;
    esac
done

# Expand path if provided (handle ~, relative paths, etc.)
if [[ -n "$PROJECT_PATH" ]]; then
    # Safely expand tilde
    PROJECT_PATH="${PROJECT_PATH/#\~/$HOME}"
    # Convert to absolute path
    if [[ ! "$PROJECT_PATH" = /* ]]; then
        PROJECT_PATH="$(pwd)/$PROJECT_PATH"
    fi
    # Verify path exists
    if [[ ! -d "$PROJECT_PATH" ]]; then
        print_error "Path does not exist: $PROJECT_PATH"
        exit 1
    fi
else
    PROJECT_PATH="$(pwd)"
fi

# Check if SwiftLint is installed
check_swiftlint() {
    if ! command -v swiftlint &> /dev/null; then
        print_error "SwiftLint is not installed"
        echo ""
        echo "Install SwiftLint with one of these methods:"
        echo ""
        echo "Homebrew:"
        echo "  brew install swiftlint"
        echo ""
        echo "Mint:"
        echo "  mint install realm/SwiftLint"
        echo ""
        echo "CocoaPods (add to Podfile):"
        echo "  pod 'SwiftLint'"
        echo ""
        echo "Download from:"
        echo "  https://github.com/realm/SwiftLint/releases"
        exit 2
    fi
}

# Get list of Swift files changed in git
get_git_changed_files() {
    local files=()

    if [[ "$STAGED_ONLY" == "true" ]]; then
        # Get only staged files
        files=($(git diff --cached --name-only --diff-filter=ACMR | grep "\.swift$" || true))
    elif [[ "$GIT_DIFF" == "true" ]]; then
        # Get all uncommitted changes (staged + unstaged)
        files=($(git diff HEAD --name-only --diff-filter=ACMR | grep "\.swift$" || true))
    fi

    echo "${files[@]}"
}

# Count Swift files in directory
count_swift_files() {
    local path="$1"
    find "$path" -name "*.swift" -type f | wc -l | tr -d ' '
}

# Parse SwiftLint output for statistics
parse_lint_output() {
    local output="$1"
    local violations=0
    local warnings=0
    local errors=0

    # Count violations from xcode reporter format
    violations=$(echo "$output" | grep -c "warning:" || echo "0")
    warnings=$violations
    errors=$(echo "$output" | grep -c "error:" || echo "0")

    echo "$violations $warnings $errors"
}

# Find .swiftlint.yml configuration
find_config() {
    local current_dir="$PROJECT_PATH"
    local max_levels=10
    local level=0

    while [[ $level -lt $max_levels ]]; do
        if [[ -f "$current_dir/.swiftlint.yml" ]]; then
            CONFIG_FILE="$current_dir/.swiftlint.yml"
            return 0
        fi

        # Move up one directory
        local parent_dir=$(dirname "$current_dir")
        if [[ "$parent_dir" == "$current_dir" ]]; then
            # Reached filesystem root
            break
        fi
        current_dir="$parent_dir"
        ((level++))
    done

    # No config found
    CONFIG_FILE=""
    return 1
}

# Construct swiftlint command
construct_swiftlint_command() {
    local cmd=("swiftlint" "lint")
    local git_files=()

    # Add config if specified or found (must come before paths)
    if [[ -n "$CONFIG" ]]; then
        cmd+=("--config" "$CONFIG")
    elif [[ -n "$CONFIG_FILE" ]]; then
        cmd+=("--config" "$CONFIG_FILE")
    fi

    # Add fix mode
    if [[ "$FIX" == "true" ]]; then
        cmd+=("--fix")
    fi

    # Add strict mode
    if [[ "$STRICT" == "true" ]]; then
        cmd+=("--strict")
    fi

    # Add reporter
    cmd+=("--reporter" "$REPORTER")

    # Add quiet mode
    if [[ "$QUIET" == "true" ]]; then
        cmd+=("--quiet")
    fi

    # Handle git-based filtering
    if [[ "$GIT_DIFF" == "true" ]] || [[ "$STAGED_ONLY" == "true" ]]; then
        git_files=($(get_git_changed_files))

        if [[ ${#git_files[@]} -eq 0 ]]; then
            print_warning "No Swift files changed in git"
            return 1
        fi

        # Add each file as positional argument
        for file in "${git_files[@]}"; do
            cmd+=("$file")
        done
    else
        # Add path as positional argument
        cmd+=("$PROJECT_PATH")
    fi

    echo "${cmd[@]}"
}

# Show summary
show_summary() {
    local exit_code=$1

    echo ""
    print_info "═══════════════════════════════════════════════════"

    if [[ $exit_code -eq 0 ]]; then
        if [[ "$FIX" == "true" ]]; then
            print_success "Auto-fix completed!"
        else
            print_success "No violations found!"
        fi
    else
        if [[ "$FIX" == "true" ]]; then
            print_warning "Some violations could not be auto-fixed"
        else
            print_error "Violations found"
        fi
    fi

    print_info "═══════════════════════════════════════════════════"
    echo ""
    echo "Project:  $(basename "$PROJECT_PATH")"
    if [[ -n "$CONFIG_FILE" ]]; then
        echo "Config:   $CONFIG_FILE"
    elif [[ -n "$CONFIG" ]]; then
        echo "Config:   $CONFIG"
    else
        echo "Config:   Default rules"
    fi
    if [[ -n "$ONLY_RULE" ]]; then
        echo "Rule:     $ONLY_RULE"
    fi
    echo "Reporter: $REPORTER"
    echo ""

    if [[ $exit_code -eq 0 ]]; then
        echo "Next steps:"
        echo "  - Run with --strict to enforce warnings"
        echo "  - Run with --fix to auto-correct violations"
        if [[ -z "$CONFIG_FILE" && -z "$CONFIG" ]]; then
            echo "  - Create .swiftlint.yml for custom rules"
        fi
    else
        echo "To fix violations:"
        if [[ "$FIX" != "true" ]]; then
            echo "  - Run: swift-lint --fix"
        fi
        echo "  - Review and fix manually"
        echo "  - Disable rules in .swiftlint.yml if needed"
        if [[ "$STRICT" != "true" ]]; then
            echo "  - Use --strict to treat warnings as errors"
        fi
    fi
    echo ""
}

# Execute linting
execute_lint() {
    print_info "═══════════════════════════════════════════════════"
    print_info "Project:  $(basename "$PROJECT_PATH")"
    if [[ -n "$CONFIG_FILE" ]]; then
        print_info "Config:   Found at $(basename "$(dirname "$CONFIG_FILE")")"
    elif [[ -n "$CONFIG" ]]; then
        print_info "Config:   $CONFIG"
    else
        print_info "Config:   Using default rules"
    fi
    if [[ "$FIX" == "true" ]]; then
        print_info "Mode:     Auto-fix"
    else
        print_info "Mode:     Lint only"
    fi

    # Show file count if stats enabled
    if [[ "$SHOW_STATS" == "true" ]]; then
        local file_count=$(count_swift_files "$PROJECT_PATH")
        print_info "Files:    $file_count Swift files"
    fi

    print_info "═══════════════════════════════════════════════════"
    echo ""

    if [[ "$FIX" == "true" ]]; then
        print_info "Auto-fixing violations..."
    else
        print_info "Linting..."
    fi
    echo ""

    local cmd=$(construct_swiftlint_command)
    local exit_code=0
    local start_time=$(date +%s)
    local output=""

    # Capture output if we need stats
    if [[ "$SHOW_STATS" == "true" ]]; then
        output=$(eval "$cmd" 2>&1) || exit_code=$?
        echo "$output"
    else
        if [[ "$VERBOSE" == "true" ]]; then
            eval "$cmd" || exit_code=$?
        else
            eval "$cmd" || exit_code=$?
        fi
    fi

    local end_time=$(date +%s)
    local duration=$((end_time - start_time))

    # Show statistics if enabled
    if [[ "$SHOW_STATS" == "true" ]]; then
        echo ""
        print_info "═══════════════════════════════════════════════════"
        print_info "STATISTICS"
        print_info "═══════════════════════════════════════════════════"
        echo "Duration: ${duration}s"

        if [[ -n "$output" ]]; then
            local warnings=$(echo "$output" | grep -c "warning:" 2>/dev/null || echo "0")
            local errors=$(echo "$output" | grep -c "error:" 2>/dev/null || echo "0")
            # Remove any newlines or extra characters
            warnings=$(echo "$warnings" | head -1 | tr -d '\n')
            errors=$(echo "$errors" | head -1 | tr -d '\n')
            echo "Warnings: $warnings"
            echo "Errors:   $errors"
            if [[ "$warnings" =~ ^[0-9]+$ ]] && [[ "$errors" =~ ^[0-9]+$ ]]; then
                echo "Total:    $((warnings + errors)) violations"
            fi
        fi
        echo ""
    fi

    show_summary $exit_code
    exit $exit_code
}

# Main execution
main() {
    # Check if SwiftLint is installed
    check_swiftlint

    # Find configuration file
    find_config

    # Change to project path
    cd "$PROJECT_PATH"

    # Execute linting
    execute_lint
}

# Run main
main

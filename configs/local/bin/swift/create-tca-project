#!/bin/bash
#
# create-tca-project - Create a new TCA Project with Modular Architecture
#
# DESCRIPTION:
#   Creates a complete TCA project structure with:
#   - Xcode project using XcodeGen
#   - Modular Features SPM package
#   - App target with SceneDelegate
#   - Workspace linking app and packages
#
# USAGE:
#   create-tca-project <ProjectName> [directory-name] [path]
#
# ARGUMENTS:
#   ProjectName      Project name in PascalCase (e.g., "TodoList")
#   directory-name   Directory name (optional, auto-converts to kebab-case)
#   path            Base path (optional, defaults to current directory)
#
# EXAMPLES:
#   create-tca-project TodoList
#   create-tca-project TodoList my-app
#   create-tca-project TodoList my-app ~/Desktop
#
# REQUIREMENTS:
#   - XcodeGen must be installed (brew install xcodegen)
#
# AUTHOR:
#   Generated for TCA development workflow
#

set -e  # Exit on error

# ANSI color codes for terminal output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'  # No Color (reset)

print_error() { echo -e "${RED}‚ùå $1${NC}"; }
print_success() { echo -e "${GREEN}‚úÖ $1${NC}"; }
print_info() { echo -e "${YELLOW}‚ÑπÔ∏è  $1${NC}"; }

show_usage() {
    cat << EOF
Usage: create-tca-project <ProjectName> [directory-name] [path]

Creates a new TCA project with modular architecture.

Arguments:
    ProjectName      Name of your project (required, PascalCase like "TodoList")
    directory-name   Directory name (optional, defaults to kebab-case like "todo-list")
    path            Base path (optional, defaults to current directory)

Examples:
    create-tca-project TodoList                    # Creates ./todo-list/
    create-tca-project TodoList my-app             # Creates ./my-app/
    create-tca-project TodoList my-app ~/Desktop   # Creates ~/Desktop/my-app/

EOF
    exit 1
}

# Check for help first
if [[ "${1:-}" == "--help" || "${1:-}" == "-h" ]]; then
    show_usage
fi

# Check XcodeGen
if ! command -v xcodegen &> /dev/null; then
    print_error "XcodeGen is not installed"
    echo ""
    echo "Install it with:"
    echo "  brew install xcodegen"
    echo ""
    exit 1
fi

if [ $# -lt 1 ]; then
    show_usage
fi

PROJECT_NAME="$1"

# Generate default directory name (convert PascalCase to kebab-case)
# TodoList -> todo-list
DEFAULT_DIR_NAME=$(echo "$PROJECT_NAME" | sed 's/\([a-z0-9]\)\([A-Z]\)/\1-\2/g' | tr '[:upper:]' '[:lower:]')

DIR_NAME="${2:-$DEFAULT_DIR_NAME}"
BASE_PATH="${3:-.}"

# Validate project name
if ! [[ "$PROJECT_NAME" =~ ^[A-Z][A-Za-z0-9]*$ ]]; then
    print_error "Invalid project name. Must start with uppercase letter (PascalCase)."
    exit 1
fi

# Safely expand tilde and convert to absolute path
BASE_PATH="$(cd "$(dirname "$BASE_PATH")" && pwd)/$(basename "$BASE_PATH")"
PROJECT_DIR="$BASE_PATH/$DIR_NAME"

if [ -d "$PROJECT_DIR" ]; then
    print_error "Directory already exists: $PROJECT_DIR"
    exit 1
fi

print_info "Creating TCA project: $PROJECT_NAME"
print_info "Directory: $PROJECT_DIR"

# Create exact structure matching todo-list
mkdir -p "$PROJECT_DIR/$PROJECT_NAME/$PROJECT_NAME/App"
mkdir -p "$PROJECT_DIR/$PROJECT_NAME/$PROJECT_NAME/Resources/Assets.xcassets/AppIcon.appiconset"
mkdir -p "$PROJECT_DIR/$PROJECT_NAME/$PROJECT_NAME/Resources/Assets.xcassets/AccentColor.colorset"
mkdir -p "$PROJECT_DIR/Features/Sources/AppFeature"
mkdir -p "$PROJECT_DIR/Features/Sources/AppSchemas"
mkdir -p "$PROJECT_DIR/Features/Sources/UIComponents"

print_success "Created directory structure"

# Create XcodeGen project.yml in ProjectName directory
cat > "$PROJECT_DIR/$PROJECT_NAME/project.yml" << YMLEOF
name: $PROJECT_NAME

options:
  bundleIdPrefix: com.example
  deploymentTarget:
    iOS: "17.0"
  generateEmptyDirectories: false
  xcodeVersion: "15.0"

fileGroups:
  - $PROJECT_NAME

targets:
  $PROJECT_NAME:
    type: application
    platform: iOS
    sources:
      - path: $PROJECT_NAME
        excludes:
          - "*.md"
    dependencies:
      - sdk: Foundation.framework
    settings:
      base:
        INFOPLIST_FILE: $PROJECT_NAME/Resources/Info.plist
        ASSETCATALOG_COMPILER_APPICON_NAME: AppIcon
        PRODUCT_BUNDLE_IDENTIFIER: com.example.$PROJECT_NAME
        SWIFT_VERSION: "6.0"
        IPHONEOS_DEPLOYMENT_TARGET: "17.0"
YMLEOF

print_success "Created XcodeGen configuration"

# Create AppDelegate.swift
cat > "$PROJECT_DIR/$PROJECT_NAME/$PROJECT_NAME/App/AppDelegate.swift" << 'EOF'
import UIKit

class AppDelegate: UIResponder, UIApplicationDelegate {
    func application(
        _ application: UIApplication,
        didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?
    ) -> Bool {
        return true
    }

    func application(
        _ application: UIApplication,
        configurationForConnecting connectingSceneSession: UISceneSession,
        options: UIScene.ConnectionOptions
    ) -> UISceneConfiguration {
        return UISceneConfiguration(
            name: "Default Configuration",
            sessionRole: connectingSceneSession.role
        )
    }
}
EOF

# Create SceneDelegate.swift
cat > "$PROJECT_DIR/$PROJECT_NAME/$PROJECT_NAME/App/SceneDelegate.swift" << 'EOF'
import UIKit
import SwiftUI
import ComposableArchitecture
import AppFeature

class SceneDelegate: UIResponder, UIWindowSceneDelegate {
    var window: UIWindow?

    func scene(
        _ scene: UIScene,
        willConnectTo session: UISceneSession,
        options connectionOptions: UIScene.ConnectionOptions
    ) {
        guard let windowScene = (scene as? UIWindowScene) else { return }

        let store = Store(initialState: AppStore.State()) {
            AppStore()
        }

        let rootView = AppView(store: store)

        let window = UIWindow(windowScene: windowScene)
        window.rootViewController = UIHostingController(rootView: rootView)
        self.window = window
        window.makeKeyAndVisible()
    }
}
EOF

# Create ProjectNameApp.swift
cat > "$PROJECT_DIR/$PROJECT_NAME/$PROJECT_NAME/App/${PROJECT_NAME}App.swift" << EOF
import SwiftUI
import ComposableArchitecture
import AppFeature

@main
struct ${PROJECT_NAME}App: App {
    let store = Store(initialState: AppStore.State()) {
        AppStore()
    }

    var body: some Scene {
        WindowGroup {
            AppView(store: store)
        }
    }
}
EOF

print_success "Created app files"

# Create Info.plist in Resources folder
cat > "$PROJECT_DIR/$PROJECT_NAME/$PROJECT_NAME/Resources/Info.plist" << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>UIApplicationSceneManifest</key>
	<dict>
		<key>UIApplicationSupportsMultipleScenes</key>
		<false/>
		<key>UISceneConfigurations</key>
		<dict>
			<key>UIWindowSceneSessionRoleApplication</key>
			<array>
				<dict>
					<key>UISceneConfigurationName</key>
					<string>Default Configuration</string>
					<key>UISceneDelegateClassName</key>
					<string>$(PRODUCT_MODULE_NAME).SceneDelegate</string>
				</dict>
			</array>
		</dict>
	</dict>
</dict>
</plist>
EOF

# Create Assets.xcassets
cat > "$PROJECT_DIR/$PROJECT_NAME/$PROJECT_NAME/Resources/Assets.xcassets/Contents.json" << 'EOF'
{
  "info" : {
    "author" : "xcode",
    "version" : 1
  }
}
EOF

cat > "$PROJECT_DIR/$PROJECT_NAME/$PROJECT_NAME/Resources/Assets.xcassets/AppIcon.appiconset/Contents.json" << 'EOF'
{
  "images" : [
    {
      "idiom" : "universal",
      "platform" : "ios",
      "size" : "1024x1024"
    }
  ],
  "info" : {
    "author" : "xcode",
    "version" : 1
  }
}
EOF

cat > "$PROJECT_DIR/$PROJECT_NAME/$PROJECT_NAME/Resources/Assets.xcassets/AccentColor.colorset/Contents.json" << 'EOF'
{
  "colors" : [
    {
      "idiom" : "universal"
    }
  ],
  "info" : {
    "author" : "xcode",
    "version" : 1
  }
}
EOF

print_success "Created resources"

# Create Features Package
cat > "$PROJECT_DIR/Features/Package.swift" << 'PKGEOF'
// swift-tools-version: 6.2
import PackageDescription

let package = Package(
    name: "Features",
    platforms: [
        .iOS(.v17), .macOS(.v14)
    ],
    products: [
        .singleTargetLibrary("AppFeature"),
        .singleTargetLibrary("AppSchemas"),
        .singleTargetLibrary("UIComponents"),
    ],
    dependencies: [
        .package(
            url: "https://github.com/pointfreeco/swift-composable-architecture.git",
            branch: "main"
        ),
    ],
    targets: [
        .target(
            name: "AppFeature",
            dependencies: [
                .product(name: "ComposableArchitecture", package: "swift-composable-architecture"),
                "AppSchemas",
            ]
        ),
        .target(
            name: "AppSchemas",
            dependencies: [
                .product(name: "ComposableArchitecture", package: "swift-composable-architecture"),
            ]
        ),
        .target(
            name: "UIComponents",
            dependencies: [
                .product(name: "ComposableArchitecture", package: "swift-composable-architecture"),
                "AppSchemas",
            ]
        ),
    ]
)

extension Product {
    static func singleTargetLibrary(_ name: String) -> Product {
        .library(name: name, targets: [name])
    }
}
PKGEOF

# Create AppFeature files
cat > "$PROJECT_DIR/Features/Sources/AppFeature/AppStore.swift" << 'EOF'
import ComposableArchitecture
import SwiftUI

@Reducer
public struct AppStore: Sendable {
    @ObservableState
    public struct State: Sendable, Equatable {
        public init() {}
    }

    public enum Action: Sendable {
        case onAppear
    }

    public var body: some Reducer<State, Action> {
        Reduce { state, action in
            switch action {
            case .onAppear:
                return .none
            }
        }
    }

    public init() {}
}
EOF

cat > "$PROJECT_DIR/Features/Sources/AppFeature/AppView.swift" << 'EOF'
import SwiftUI
import ComposableArchitecture

public struct AppView: View {
    let store: StoreOf<AppStore>

    public init(store: StoreOf<AppStore>) {
        self.store = store
    }

    public var body: some View {
        Text("Hello, TCA!")
            .fontDesign(.monospaced)
            .onAppear {
                store.send(.onAppear)
            }
    }
}

#Preview {
    AppView(
        store: Store(initialState: AppStore.State()) {
            AppStore()
        }
    )
}
EOF

cat > "$PROJECT_DIR/Features/Sources/AppSchemas/AppSchemas.swift" << 'EOF'
import Foundation

// Shared data models and schemas go here
EOF

cat > "$PROJECT_DIR/Features/Sources/UIComponents/UIComponents.swift" << 'EOF'
import SwiftUI

// Reusable UI components go here
EOF

print_success "Created Features package"

# Generate Xcode project with XcodeGen
cd "$PROJECT_DIR/$PROJECT_NAME"
print_info "Generating Xcode project with XcodeGen..."
xcodegen generate

print_success "Generated Xcode project"

# Create workspace at root level
cd "$PROJECT_DIR"
print_info "Creating Xcode workspace..."

mkdir -p "$PROJECT_NAME.xcworkspace"

cat > "$PROJECT_NAME.xcworkspace/contents.xcworkspacedata" << WSEOF
<?xml version="1.0" encoding="UTF-8"?>
<Workspace
   version = "1.0">
   <FileRef
      location = "group:$PROJECT_NAME/$PROJECT_NAME.xcodeproj">
   </FileRef>
   <FileRef
      location = "group:Features">
   </FileRef>
</Workspace>
WSEOF

print_success "Created workspace"

# Create .gitignore to exclude Packages folder
cat > "$PROJECT_DIR/.gitignore" << 'GITEOF'
# Xcode
*.xcuserstate
*.xcuserdatad
xcuserdata/
DerivedData/
*.moved-aside
*.pbxuser
!default.pbxuser
*.mode1v3
!default.mode1v3
*.mode2v3
!default.mode2v3
*.perspectivev3
!default.perspectivev3

# Swift Package Manager
.build/
.swiftpm/
Packages/
Package.resolved

# macOS
.DS_Store
GITEOF

print_success "Created .gitignore"

# Create README
cat > "$PROJECT_DIR/README.md" << EOF
# $PROJECT_NAME

A TCA (The Composable Architecture) project with modular architecture.

## Structure

\`\`\`
$DIR_NAME/
‚îú‚îÄ‚îÄ $PROJECT_NAME.xcworkspace/
‚îú‚îÄ‚îÄ $PROJECT_NAME/
‚îÇ   ‚îú‚îÄ‚îÄ $PROJECT_NAME/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ App/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AppDelegate.swift
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SceneDelegate.swift
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ${PROJECT_NAME}App.swift
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Resources/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ Info.plist
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ Assets.xcassets/
‚îÇ   ‚îî‚îÄ‚îÄ $PROJECT_NAME.xcodeproj/
‚îî‚îÄ‚îÄ Features/
    ‚îú‚îÄ‚îÄ Package.swift
    ‚îî‚îÄ‚îÄ Sources/
        ‚îú‚îÄ‚îÄ AppFeature/
        ‚îú‚îÄ‚îÄ AppSchemas/
        ‚îî‚îÄ‚îÄ UIComponents/
\`\`\`

## Getting Started

1. Open the workspace:
   \`\`\`bash
   cd $PROJECT_DIR
   open $PROJECT_NAME.xcworkspace
   \`\`\`

2. Add the Features package to your app target:
   - Select \`$PROJECT_NAME\` project in the navigator
   - Select \`$PROJECT_NAME\` target
   - Go to "General" tab
   - Scroll to "Frameworks, Libraries, and Embedded Content"
   - You'll see \`Foundation.framework\` (iOS system framework, can be removed if desired)
   - Click the \`+\` button
   - Click "Add Other" ‚Üí "Add Package Dependency"
   - Navigate to \`Features\` folder and click "Add Package"
   - Select \`AppFeature\` and click "Add"

3. Build and run (‚åòR)
EOF

print_info "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
print_success "Project created successfully!"
print_info "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo ""
echo "üìÅ Location: $PROJECT_DIR"
echo ""
echo "Structure:"
tree -L 3 "$PROJECT_DIR" 2>/dev/null || find "$PROJECT_DIR" -maxdepth 3 -print | sed 's/[^/]*\//  /g'
echo ""
echo "Next steps:"
echo "  cd $PROJECT_DIR"
echo "  open $PROJECT_NAME.xcworkspace"
echo ""

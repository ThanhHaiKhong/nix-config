#!/bin/bash
#
# swift-deps - Swift Package Manager Dependency Manager
#
# DESCRIPTION:
#   Manages Swift Package Manager dependencies with convenience commands.
#   Wrapper around `swift package` for common dependency operations.
#
# USAGE:
#   swift-deps [COMMAND] [PATH] [OPTIONS]
#
# COMMANDS:
#   update [NAME]         Update all dependencies or specific package
#   resolve               Resolve Package.resolved
#   show                  Show dependency tree
#   outdated              Check for outdated dependencies
#   clean                 Clean dependency cache
#   reset                 Reset Package.resolved
#
# EXAMPLES:
#   swift-deps update
#   swift-deps update TCA
#   swift-deps show
#   swift-deps outdated
#
# FEATURES:
#   - Auto-detects Package.swift in parent directories
#   - Shows current dependency versions
#   - Supports path expansion (~, ./, ../)
#   - Works from any subdirectory
#
# AUTHOR:
#   Swift development tooling
#

set -e  # Exit on error

# ANSI color codes for terminal output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'  # No Color (reset)

# Helper functions for colored output
print_error() {
    echo -e "${RED}❌ $1${NC}"
}

print_success() {
    echo -e "${GREEN}✅ $1${NC}"
}

print_info() {
    echo -e "${YELLOW}ℹ️  $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}⚠️  $1${NC}"
}

# Usage documentation
show_usage() {
    cat << EOF
Usage: swift-deps [COMMAND] [PATH] [OPTIONS]

Manage Swift Package Manager dependencies.

Commands:
    update [NAME]         Update all dependencies or specific package
    resolve               Resolve Package.resolved
    show                  Show dependency tree
    outdated              Check for outdated dependencies
    clean                 Clean dependency cache
    reset                 Reset Package.resolved

Arguments:
    PATH                  Optional path to project directory [default: current directory]

Examples:
    swift-deps update                            # Update all dependencies
    swift-deps update TCA                        # Update specific package
    swift-deps resolve                           # Resolve dependencies
    swift-deps show                              # Show dependency tree
    swift-deps outdated                          # Check for updates
    swift-deps clean                             # Clean cache
    swift-deps reset                             # Reset Package.resolved
    swift-deps update ~/Projects/MyApp           # Update specific project

Notes:
    - Requires Swift Package Manager (swift package)
    - Auto-detects Package.swift in project
    - Works from any subdirectory

EOF
    exit 1
}

# Default values
COMMAND=""
PACKAGE_NAME=""
PROJECT_PATH=""

# Parse arguments
if [[ $# -eq 0 ]]; then
    show_usage
fi

# First argument is the command
COMMAND="$1"
shift

# Parse remaining arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --help|-h)
            show_usage
            ;;
        -*)
            print_error "Unknown option: $1"
            show_usage
            ;;
        *)
            # Positional argument
            if [[ -z "$PROJECT_PATH" ]]; then
                # Could be package name for update command, or project path
                if [[ "$COMMAND" == "update" ]] && [[ ! -d "$1" ]]; then
                    PACKAGE_NAME="$1"
                else
                    PROJECT_PATH="$1"
                fi
            else
                print_error "Too many arguments"
                show_usage
            fi
            shift
            ;;
    esac
done

# Expand path if provided (handle ~, relative paths, etc.)
if [[ -n "$PROJECT_PATH" ]]; then
    # Safely expand tilde
    PROJECT_PATH="${PROJECT_PATH/#\~/$HOME}"
    # Convert to absolute path
    if [[ ! "$PROJECT_PATH" = /* ]]; then
        PROJECT_PATH="$(pwd)/$PROJECT_PATH"
    fi
    # Verify path exists
    if [[ ! -d "$PROJECT_PATH" ]]; then
        print_error "Path does not exist: $PROJECT_PATH"
        exit 1
    fi
else
    PROJECT_PATH="$(pwd)"
fi

# Find Package.swift
find_package_swift() {
    local current_dir="$PROJECT_PATH"
    local max_levels=10
    local level=0

    while [[ $level -lt $max_levels ]]; do
        if [[ -f "$current_dir/Package.swift" ]]; then
            PACKAGE_DIR="$current_dir"
            return 0
        fi

        # Move up one directory
        local parent_dir=$(dirname "$current_dir")
        if [[ "$parent_dir" == "$current_dir" ]]; then
            # Reached filesystem root
            break
        fi
        current_dir="$parent_dir"
        ((level++))
    done

    print_error "No Package.swift found"
    echo ""
    echo "Searched from: $PROJECT_PATH"
    echo "Looking for: Package.swift"
    echo ""
    echo "This command only works with Swift Package Manager projects"
    exit 1
}

# Update dependencies
cmd_update() {
    print_info "Updating dependencies..."
    echo ""

    cd "$PACKAGE_DIR"

    if [[ -n "$PACKAGE_NAME" ]]; then
        print_info "Updating package: $PACKAGE_NAME"
        swift package update "$PACKAGE_NAME"
    else
        print_info "Updating all dependencies"
        swift package update
    fi

    echo ""
    print_success "Dependencies updated!"
}

# Resolve dependencies
cmd_resolve() {
    print_info "Resolving dependencies..."
    echo ""

    cd "$PACKAGE_DIR"
    swift package resolve

    echo ""
    print_success "Dependencies resolved!"
}

# Show dependency tree
cmd_show() {
    print_info "Dependency tree:"
    echo ""

    cd "$PACKAGE_DIR"
    swift package show-dependencies

    echo ""
}

# Check for outdated dependencies
cmd_outdated() {
    print_info "Checking for outdated dependencies..."
    echo ""

    cd "$PACKAGE_DIR"

    # Get current dependencies
    if [[ ! -f "Package.resolved" ]]; then
        print_warning "Package.resolved not found. Run 'swift-deps resolve' first."
        exit 1
    fi

    print_info "Current dependencies (from Package.resolved):"
    echo ""

    # Parse Package.resolved and show current versions
    if command -v jq &> /dev/null; then
        # Use jq if available
        jq -r '.pins[] | "  \(.identity): \(.state.version // .state.branch // .state.revision[0:7])"' Package.resolved
    else
        # Fallback to basic grep
        grep -A 3 '"identity"' Package.resolved | grep -E '(identity|version|branch)' | sed 's/^/  /'
    fi

    echo ""
    print_info "To update: swift-deps update"
}

# Clean dependency cache
cmd_clean() {
    print_info "Cleaning dependency cache..."
    echo ""

    cd "$PACKAGE_DIR"

    # Clean build folder
    if [[ -d ".build" ]]; then
        local size=$(du -sh .build 2>/dev/null | awk '{print $1}')
        rm -rf .build
        print_success "Removed .build ($size)"
    fi

    # Clean SPM cache
    swift package clean-cache

    echo ""
    print_success "Cache cleaned!"
}

# Reset Package.resolved
cmd_reset() {
    print_info "Resetting Package.resolved..."
    echo ""

    cd "$PACKAGE_DIR"

    if [[ -f "Package.resolved" ]]; then
        rm -f Package.resolved
        print_success "Removed Package.resolved"
    else
        print_warning "Package.resolved not found"
    fi

    print_info "Run 'swift-deps resolve' to regenerate"
    echo ""
}

# Main execution
main() {
    # Find Package.swift
    find_package_swift

    print_info "═══════════════════════════════════════════════════"
    print_info "Project: $(basename "$PACKAGE_DIR")"
    print_info "Command: $COMMAND"
    print_info "═══════════════════════════════════════════════════"
    echo ""

    # Execute command
    case "$COMMAND" in
        update)
            cmd_update
            ;;
        resolve)
            cmd_resolve
            ;;
        show)
            cmd_show
            ;;
        outdated)
            cmd_outdated
            ;;
        clean)
            cmd_clean
            ;;
        reset)
            cmd_reset
            ;;
        *)
            print_error "Unknown command: $COMMAND"
            echo ""
            echo "Valid commands: update, resolve, show, outdated, clean, reset"
            exit 1
            ;;
    esac
}

# Run main
main

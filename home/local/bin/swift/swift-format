#!/bin/bash
#
# swift-format - Swift Code Formatter Wrapper
#
# DESCRIPTION:
#   Formats Swift code with swift-format (Apple's official formatter).
#   Auto-detects .swift-format configuration files.
#   Supports in-place formatting, validation, and multiple output modes.
#
# USAGE:
#   swift-format [PATH] [OPTIONS]
#
# ARGUMENTS:
#   PATH                  Path to file/directory (optional, defaults to current directory)
#
# OPTIONS:
#   --in-place, -i        Format files in-place (modifies files)
#   --validate            Check if files are formatted (exit non-zero if not)
#   --recursive, -r       Format directories recursively
#   --parallel            Format files in parallel
#   --config PATH         Custom configuration file path
#   --quiet, -q           Suppress output
#   --verbose, -v         Show detailed output
#   --stats               Show formatting statistics
#   --git-diff            Format only files changed in git
#   --staged              Format only staged files in git
#
# EXAMPLES:
#   swift-format                                # Format current directory (dry run)
#   swift-format --in-place                     # Format current directory in-place
#   swift-format --validate                     # Check if files are formatted
#   swift-format MyFile.swift --in-place        # Format specific file
#   swift-format Sources --recursive --in-place # Format directory recursively
#   swift-format --git-diff --in-place          # Format uncommitted changes
#   swift-format --staged --in-place            # Format staged files
#   swift-format --stats --in-place             # Format with statistics
#
# REQUIREMENTS:
#   - swift-format must be installed (brew install swift-format)
#
# AUTHOR:
#   Swift development tooling
#

set -e  # Exit on error

# ANSI color codes for terminal output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'  # No Color (reset)

# Helper functions for colored output
print_error() {
    echo -e "${RED}❌ $1${NC}"
}

print_success() {
    echo -e "${GREEN}✅ $1${NC}"
}

print_info() {
    echo -e "${YELLOW}ℹ️  $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}⚠️  $1${NC}"
}

# Usage documentation
show_usage() {
    cat << EOF
Usage: swift-format [PATH] [OPTIONS]

Format Swift code with swift-format (Apple's official formatter).

Arguments:
    PATH                  Optional path to file or directory [default: current directory]

Options:
    --in-place, -i        Format files in-place (modifies files)
    --validate            Check if files are formatted correctly (exit non-zero if not)
    --recursive, -r       Format directories recursively
    --parallel            Format files in parallel (faster for large projects)
    --config PATH         Custom configuration file path
    --quiet, -q           Suppress output
    --verbose, -v         Show detailed output
    --stats               Show formatting statistics
    --git-diff            Format only files changed in git (uncommitted changes)
    --staged              Format only staged files in git
    --help, -h            Show this help

Examples:
    swift-format                                # Show formatted output (dry run)
    swift-format --in-place                     # Format current directory in-place
    swift-format --validate                     # Check if files are formatted
    swift-format MyFile.swift -i                # Format specific file
    swift-format Sources -r -i                  # Format directory recursively
    swift-format --git-diff -i                  # Format uncommitted changes
    swift-format --staged -i                    # Format staged files
    swift-format --parallel -i                  # Format in parallel
    swift-format --stats -i                     # Format with statistics

Notes:
    - Requires swift-format to be installed (brew install swift-format)
    - Auto-detects .swift-format configuration
    - Without --in-place, outputs formatted code to stdout
    - --validate mode is useful for CI/CD pipelines
    - Works from any subdirectory within a project

EOF
    exit 1
}

# Default values
IN_PLACE=false
VALIDATE=false
RECURSIVE=false
PARALLEL=false
CONFIG=""
QUIET=false
VERBOSE=false
TARGET_PATH=""
GIT_DIFF=false
STAGED_ONLY=false
SHOW_STATS=false

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --in-place|-i)
            IN_PLACE=true
            shift
            ;;
        --validate)
            VALIDATE=true
            shift
            ;;
        --recursive|-r)
            RECURSIVE=true
            shift
            ;;
        --parallel)
            PARALLEL=true
            shift
            ;;
        --config)
            CONFIG="$2"
            shift 2
            ;;
        --quiet|-q)
            QUIET=true
            shift
            ;;
        --verbose|-v)
            VERBOSE=true
            shift
            ;;
        --git-diff)
            GIT_DIFF=true
            shift
            ;;
        --staged)
            STAGED_ONLY=true
            shift
            ;;
        --stats)
            SHOW_STATS=true
            shift
            ;;
        --help|-h)
            show_usage
            ;;
        -*)
            print_error "Unknown option: $1"
            show_usage
            ;;
        *)
            # Positional argument - treat as target path
            if [[ -z "$TARGET_PATH" ]]; then
                TARGET_PATH="$1"
            else
                print_error "Multiple paths specified: $TARGET_PATH and $1"
                show_usage
            fi
            shift
            ;;
    esac
done

# Expand path if provided (handle ~, relative paths, etc.)
if [[ -n "$TARGET_PATH" ]]; then
    # Safely expand tilde
    TARGET_PATH="${TARGET_PATH/#\~/$HOME}"
    # Convert to absolute path
    if [[ ! "$TARGET_PATH" = /* ]]; then
        TARGET_PATH="$(pwd)/$TARGET_PATH"
    fi
    # Verify path exists
    if [[ ! -e "$TARGET_PATH" ]]; then
        print_error "Path does not exist: $TARGET_PATH"
        exit 1
    fi
else
    TARGET_PATH="$(pwd)"
fi

# Check if swift-format is installed and find its path
check_swift_format() {
    # Find swift-format binary, excluding this script
    local script_path="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/$(basename "${BASH_SOURCE[0]}")"
    local resolved_script_path="$(readlink -f "$script_path" 2>/dev/null || echo "$script_path")"

    # Find all swift-format executables in PATH
    while IFS= read -r binary_path; do
        local resolved_binary="$(readlink -f "$binary_path" 2>/dev/null || echo "$binary_path")"
        # Skip if it's this script or its symlink
        if [[ "$binary_path" != "$script_path" ]] && \
           [[ "$resolved_binary" != "$resolved_script_path" ]] && \
           [[ -x "$binary_path" ]]; then
            SWIFT_FORMAT_BIN="$binary_path"
            return 0
        fi
    done < <(which -a swift-format 2>/dev/null || true)

    # If not found in PATH, try common locations
    if [[ -x "/opt/homebrew/bin/swift-format" ]]; then
        SWIFT_FORMAT_BIN="/opt/homebrew/bin/swift-format"
        return 0
    elif [[ -x "/usr/local/bin/swift-format" ]]; then
        SWIFT_FORMAT_BIN="/usr/local/bin/swift-format"
        return 0
    fi

    print_error "swift-format is not installed"
    echo ""
    echo "Install swift-format with one of these methods:"
    echo ""
    echo "Homebrew:"
    echo "  brew install swift-format"
    echo ""
    echo "Mint:"
    echo "  mint install apple/swift-format"
    echo ""
    echo "Build from source:"
    echo "  git clone https://github.com/apple/swift-format.git"
    echo "  cd swift-format"
    echo "  swift build -c release"
    echo ""
    echo "Download from:"
    echo "  https://github.com/apple/swift-format/releases"
    exit 2
}

# Get list of Swift files changed in git
get_git_changed_files() {
    local files=()

    if [[ "$STAGED_ONLY" == "true" ]]; then
        # Get only staged files
        files=($(git diff --cached --name-only --diff-filter=ACMR | grep "\.swift$" || true))
    elif [[ "$GIT_DIFF" == "true" ]]; then
        # Get all uncommitted changes (staged + unstaged)
        files=($(git diff HEAD --name-only --diff-filter=ACMR | grep "\.swift$" || true))
    fi

    echo "${files[@]}"
}

# Count Swift files in directory or specific file
count_swift_files() {
    local path="$1"
    if [[ -f "$path" ]]; then
        echo "1"
    else
        find "$path" -name "*.swift" -type f | wc -l | tr -d ' '
    fi
}

# Find .swift-format configuration
find_config() {
    local current_dir
    if [[ -f "$TARGET_PATH" ]]; then
        current_dir="$(dirname "$TARGET_PATH")"
    else
        current_dir="$TARGET_PATH"
    fi

    local max_levels=10
    local level=0

    while [[ $level -lt $max_levels ]]; do
        if [[ -f "$current_dir/.swift-format" ]]; then
            CONFIG_FILE="$current_dir/.swift-format"
            return 0
        fi

        # Move up one directory
        local parent_dir=$(dirname "$current_dir")
        if [[ "$parent_dir" == "$current_dir" ]]; then
            # Reached filesystem root
            break
        fi
        current_dir="$parent_dir"
        ((level++))
    done

    # No config found
    CONFIG_FILE=""
    return 1
}

# Format a single file
format_file() {
    local file="$1"
    local cmd=("$SWIFT_FORMAT_BIN")

    # Add config if specified or found
    if [[ -n "$CONFIG" ]]; then
        cmd+=("--configuration" "$CONFIG")
    elif [[ -n "$CONFIG_FILE" ]]; then
        cmd+=("--configuration" "$CONFIG_FILE")
    fi

    # Add mode flags
    if [[ "$IN_PLACE" == "true" ]]; then
        cmd+=("--in-place")
    fi

    if [[ "$VALIDATE" == "true" ]]; then
        cmd+=("lint")
    else
        cmd+=("format")
    fi

    # Add the file
    cmd+=("$file")

    # Execute
    if [[ "$VERBOSE" == "true" ]]; then
        echo "Formatting: $file"
    fi

    "${cmd[@]}"
}

# Format multiple files in parallel
format_files_parallel() {
    local files=("$@")
    local pids=()
    local failed=0

    for file in "${files[@]}"; do
        format_file "$file" &
        pids+=($!)
    done

    # Wait for all processes
    for pid in "${pids[@]}"; do
        if ! wait "$pid"; then
            ((failed++))
        fi
    done

    return $failed
}

# Format directory or file
format_target() {
    local target="$1"
    local cmd=("$SWIFT_FORMAT_BIN")
    local files=()
    local exit_code=0

    # Handle git-based filtering
    if [[ "$GIT_DIFF" == "true" ]] || [[ "$STAGED_ONLY" == "true" ]]; then
        files=($(get_git_changed_files))

        if [[ ${#files[@]} -eq 0 ]]; then
            print_warning "No Swift files changed in git"
            return 0
        fi

        if [[ "$PARALLEL" == "true" ]] && [[ "$IN_PLACE" == "true" ]]; then
            format_files_parallel "${files[@]}" || exit_code=$?
        else
            for file in "${files[@]}"; do
                format_file "$file" || exit_code=$?
            done
        fi

        return $exit_code
    fi

    # Add config if specified or found
    if [[ -n "$CONFIG" ]]; then
        cmd+=("--configuration" "$CONFIG")
    elif [[ -n "$CONFIG_FILE" ]]; then
        cmd+=("--configuration" "$CONFIG_FILE")
    fi

    # Add mode flags
    if [[ "$IN_PLACE" == "true" ]]; then
        cmd+=("--in-place")
    fi

    if [[ "$VALIDATE" == "true" ]]; then
        cmd+=("lint")
    else
        cmd+=("format")
    fi

    # Add recursive flag
    if [[ "$RECURSIVE" == "true" ]] || [[ -d "$target" ]]; then
        cmd+=("--recursive")
    fi

    # Add parallel flag
    if [[ "$PARALLEL" == "true" ]]; then
        cmd+=("--parallel")
    fi

    # Add target
    cmd+=("$target")

    # Execute
    if [[ "$QUIET" == "true" ]]; then
        "${cmd[@]}" > /dev/null 2>&1 || exit_code=$?
    else
        "${cmd[@]}" || exit_code=$?
    fi

    return $exit_code
}

# Show summary
show_summary() {
    local exit_code=$1
    local file_count=$2

    echo ""
    print_info "═══════════════════════════════════════════════════"

    if [[ $exit_code -eq 0 ]]; then
        if [[ "$VALIDATE" == "true" ]]; then
            print_success "All files are properly formatted!"
        elif [[ "$IN_PLACE" == "true" ]]; then
            print_success "Formatting completed!"
        else
            print_success "Formatting preview completed!"
        fi
    else
        if [[ "$VALIDATE" == "true" ]]; then
            print_error "Some files need formatting"
        else
            print_error "Formatting encountered issues"
        fi
    fi

    print_info "═══════════════════════════════════════════════════"
    echo ""

    if [[ -f "$TARGET_PATH" ]]; then
        echo "File:     $(basename "$TARGET_PATH")"
    else
        echo "Project:  $(basename "$TARGET_PATH")"
    fi

    if [[ -n "$CONFIG_FILE" ]]; then
        echo "Config:   $CONFIG_FILE"
    elif [[ -n "$CONFIG" ]]; then
        echo "Config:   $CONFIG"
    else
        echo "Config:   Default style"
    fi

    if [[ "$IN_PLACE" == "true" ]]; then
        echo "Mode:     In-place"
    elif [[ "$VALIDATE" == "true" ]]; then
        echo "Mode:     Validate"
    else
        echo "Mode:     Preview (stdout)"
    fi

    if [[ "$SHOW_STATS" == "true" ]]; then
        echo "Files:    $file_count Swift files"
    fi

    echo ""

    if [[ $exit_code -eq 0 ]]; then
        echo "Next steps:"
        if [[ "$IN_PLACE" != "true" ]] && [[ "$VALIDATE" != "true" ]]; then
            echo "  - Run with --in-place to format files"
        fi
        echo "  - Run with --validate in CI/CD pipelines"
        if [[ -z "$CONFIG_FILE" && -z "$CONFIG" ]]; then
            echo "  - Create .swift-format for custom style"
        fi
    else
        echo "To fix formatting:"
        if [[ "$IN_PLACE" != "true" ]]; then
            echo "  - Run: swift-format --in-place"
        fi
        echo "  - Review changes carefully"
        if [[ -z "$CONFIG_FILE" && -z "$CONFIG" ]]; then
            echo "  - Configure style with .swift-format file"
        fi
    fi
    echo ""
}

# Execute formatting
execute_format() {
    local file_count=0

    if [[ "$SHOW_STATS" == "true" ]] || [[ "$VERBOSE" == "true" ]]; then
        file_count=$(count_swift_files "$TARGET_PATH")
    fi

    print_info "═══════════════════════════════════════════════════"

    if [[ -f "$TARGET_PATH" ]]; then
        print_info "File:     $(basename "$TARGET_PATH")"
    else
        print_info "Project:  $(basename "$TARGET_PATH")"
    fi

    if [[ -n "$CONFIG_FILE" ]]; then
        print_info "Config:   Found at $(basename "$(dirname "$CONFIG_FILE")")"
    elif [[ -n "$CONFIG" ]]; then
        print_info "Config:   $CONFIG"
    else
        print_info "Config:   Using default style"
    fi

    if [[ "$IN_PLACE" == "true" ]]; then
        print_info "Mode:     In-place (will modify files)"
    elif [[ "$VALIDATE" == "true" ]]; then
        print_info "Mode:     Validate only"
    else
        print_info "Mode:     Preview (stdout)"
    fi

    if [[ "$SHOW_STATS" == "true" ]]; then
        print_info "Files:    $file_count Swift files"
    fi

    print_info "═══════════════════════════════════════════════════"
    echo ""

    if [[ "$VALIDATE" == "true" ]]; then
        print_info "Validating formatting..."
    elif [[ "$IN_PLACE" == "true" ]]; then
        print_info "Formatting files in-place..."
    else
        print_info "Previewing formatted code..."
    fi
    echo ""

    local start_time=$(date +%s)
    local exit_code=0

    format_target "$TARGET_PATH" || exit_code=$?

    local end_time=$(date +%s)
    local duration=$((end_time - start_time))

    # Show statistics if enabled
    if [[ "$SHOW_STATS" == "true" ]]; then
        echo ""
        print_info "═══════════════════════════════════════════════════"
        print_info "STATISTICS"
        print_info "═══════════════════════════════════════════════════"
        echo "Duration: ${duration}s"
        echo "Files:    $file_count Swift files"
        echo ""
    fi

    show_summary $exit_code $file_count
    exit $exit_code
}

# Main execution
main() {
    # Check if swift-format is installed
    check_swift_format

    # Find configuration file
    find_config || true  # It's OK if no config found

    # Execute formatting
    execute_format
}

# Run main
main

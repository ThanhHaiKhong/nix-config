#!/bin/bash
#
# swift-clean - Swift Project Build Artifacts Cleaner
#
# DESCRIPTION:
#   Cleans Swift project build artifacts and caches.
#   Removes .build, build, DerivedData directories.
#   Can clean all projects recursively in a directory tree.
#
# USAGE:
#   swift-clean [PATH] [OPTIONS]
#
# ARGUMENTS:
#   PATH                  Path to project directory (optional)
#
# OPTIONS:
#   --all                 Clean all projects recursively
#   --deep                Deep clean (includes DerivedData, SPM caches, Xcode caches)
#   --dry-run             Show what would be deleted without deleting
#   --derived-data        Clean DerivedData only
#   --spm-cache           Clean SPM cache only
#
# EXAMPLES:
#   swift-clean
#   swift-clean ~/Projects/MyApp --deep
#   swift-clean --all --dry-run
#
# FEATURES:
#   - Shows space saved after cleaning
#   - Dry-run mode to preview deletions
#   - Recursive cleaning of multiple projects
#   - No external dependencies (pure bash)
#
# AUTHOR:
#   Swift development tooling
#

set -e  # Exit on error

# ANSI color codes for terminal output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'  # No Color (reset)

# Helper functions for colored output
print_error() {
    echo -e "${RED}❌ $1${NC}"
}

print_success() {
    echo -e "${GREEN}✅ $1${NC}"
}

print_info() {
    echo -e "${YELLOW}ℹ️  $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}⚠️  $1${NC}"
}

# Usage documentation
show_usage() {
    cat << EOF
Usage: swift-clean [PATH] [OPTIONS]

Clean Swift project build artifacts and caches.

Arguments:
    PATH                  Optional path to project directory [default: current directory]

Options:
    --all                 Clean all projects recursively in directory tree
    --deep                Deep clean (includes DerivedData, SPM caches, Xcode caches)
    --dry-run             Show what would be deleted without deleting
    --derived-data        Clean DerivedData only
    --spm-cache           Clean SPM cache only
    --help, -h            Show this help

Examples:
    swift-clean                              # Clean current project
    swift-clean ~/Projects/MyApp             # Clean specific project
    swift-clean --deep                       # Deep clean with all caches
    swift-clean --all                        # Clean all projects in tree
    swift-clean --dry-run                    # Preview what will be deleted
    swift-clean ~/Desktop/AppExample --all   # Clean all projects recursively

Notes:
    - Removes .build, build, DerivedData directories
    - Can clean SPM caches and Xcode caches with --deep
    - Use --dry-run to preview before actual deletion
    - Shows space saved after cleaning

EOF
    exit 1
}

# Default values
CLEAN_ALL=false
DEEP_CLEAN=false
DRY_RUN=false
DERIVED_DATA_ONLY=false
SPM_CACHE_ONLY=false
PROJECT_PATH=""
TOTAL_SPACE_SAVED=0

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --all)
            CLEAN_ALL=true
            shift
            ;;
        --deep)
            DEEP_CLEAN=true
            shift
            ;;
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        --derived-data)
            DERIVED_DATA_ONLY=true
            shift
            ;;
        --spm-cache)
            SPM_CACHE_ONLY=true
            shift
            ;;
        --help|-h)
            show_usage
            ;;
        -*)
            print_error "Unknown option: $1"
            show_usage
            ;;
        *)
            # Positional argument - treat as project path
            if [[ -z "$PROJECT_PATH" ]]; then
                PROJECT_PATH="$1"
            else
                print_error "Multiple paths specified: $PROJECT_PATH and $1"
                show_usage
            fi
            shift
            ;;
    esac
done

# Expand path if provided (handle ~, relative paths, etc.)
if [[ -n "$PROJECT_PATH" ]]; then
    # Safely expand tilde
    PROJECT_PATH="${PROJECT_PATH/#\~/$HOME}"
    # Convert to absolute path
    if [[ ! "$PROJECT_PATH" = /* ]]; then
        PROJECT_PATH="$(pwd)/$PROJECT_PATH"
    fi
    # Verify path exists
    if [[ ! -d "$PROJECT_PATH" ]]; then
        print_error "Path does not exist: $PROJECT_PATH"
        exit 1
    fi
else
    PROJECT_PATH="$(pwd)"
fi

# Get directory size
get_size() {
    local path="$1"
    if [[ -d "$path" ]]; then
        du -sk "$path" 2>/dev/null | awk '{print $1}'
    else
        echo "0"
    fi
}

# Format size in human readable format
#
# Converts kilobytes to human-readable format (KB, MB, GB)
# Uses pure bash arithmetic (no bc dependency)
#
# Arguments:
#   $1 - Size in kilobytes
#
# Output:
#   Formatted string with 2 decimal places for MB/GB
#
# Examples:
#   format_size 500      -> "500 KB"
#   format_size 2048     -> "2.00 MB"
#   format_size 1048576  -> "1.00 GB"
format_size() {
    local size_kb=$1
    if [[ $size_kb -ge 1048576 ]]; then
        # Convert to GB with 2 decimal places (1 GB = 1048576 KB)
        # Multiply by 100 first to preserve 2 decimal places in integer math
        local gb_int=$((size_kb * 100 / 1048576))
        local gb_whole=$((gb_int / 100))
        local gb_decimal=$((gb_int % 100))
        printf "%d.%02d GB\n" "$gb_whole" "$gb_decimal"
    elif [[ $size_kb -ge 1024 ]]; then
        # Convert to MB with 2 decimal places (1 MB = 1024 KB)
        local mb_int=$((size_kb * 100 / 1024))
        local mb_whole=$((mb_int / 100))
        local mb_decimal=$((mb_int % 100))
        printf "%d.%02d MB\n" "$mb_whole" "$mb_decimal"
    else
        # Less than 1 MB, show in KB
        echo "${size_kb} KB"
    fi
}

# Clean a directory
clean_directory() {
    local dir="$1"
    local description="$2"

    if [[ -d "$dir" ]]; then
        local size=$(get_size "$dir")
        TOTAL_SPACE_SAVED=$((TOTAL_SPACE_SAVED + size))

        if [[ "$DRY_RUN" == "true" ]]; then
            print_info "Would delete: $dir ($(format_size $size))"
        else
            rm -rf "$dir"
            print_success "Cleaned $description: $(format_size $size)"
        fi
    fi
}

# Clean single project
clean_project() {
    local project_path="$1"
    local project_name=$(basename "$project_path")

    print_info "Cleaning: $project_name"

    # Clean .build (SPM)
    clean_directory "$project_path/.build" ".build directory"

    # Clean build (Xcode)
    clean_directory "$project_path/build" "build directory"

    # Find and clean DerivedData for this project
    if [[ "$DEEP_CLEAN" == "true" || "$DERIVED_DATA_ONLY" == "true" ]]; then
        local derived_data="$HOME/Library/Developer/Xcode/DerivedData"
        if [[ -d "$derived_data" ]]; then
            # Find project-specific DerivedData
            for dd in "$derived_data"/*; do
                if [[ -d "$dd" ]] && echo "$(basename "$dd")" | grep -q "$project_name"; then
                    clean_directory "$dd" "DerivedData"
                fi
            done
        fi
    fi

    echo ""
}

# Clean all projects in directory tree
clean_all_projects() {
    print_info "Searching for Swift projects in: $PROJECT_PATH"
    echo ""

    local count=0

    # Find all Package.swift files
    while IFS= read -r package_file; do
        local project_dir=$(dirname "$package_file")
        clean_project "$project_dir"
        ((count++))
    done < <(find "$PROJECT_PATH" -name "Package.swift" -type f 2>/dev/null)

    # Find all .xcworkspace files
    while IFS= read -r workspace_file; do
        local project_dir=$(dirname "$workspace_file")
        clean_project "$project_dir"
        ((count++))
    done < <(find "$PROJECT_PATH" -name "*.xcworkspace" -type d 2>/dev/null)

    # Find all .xcodeproj files (but skip if workspace exists)
    while IFS= read -r project_file; do
        local project_dir=$(dirname "$project_file")
        # Check if workspace exists in same directory
        if ! find "$project_dir" -maxdepth 1 -name "*.xcworkspace" -type d 2>/dev/null | grep -q .; then
            clean_project "$project_dir"
            ((count++))
        fi
    done < <(find "$PROJECT_PATH" -name "*.xcodeproj" -type d 2>/dev/null)

    print_info "Cleaned $count projects"
}

# Clean global caches
clean_global_caches() {
    print_info "Cleaning global caches..."
    echo ""

    # Clean DerivedData
    if [[ "$DEEP_CLEAN" == "true" || "$DERIVED_DATA_ONLY" == "true" ]]; then
        local derived_data="$HOME/Library/Developer/Xcode/DerivedData"
        clean_directory "$derived_data" "All DerivedData"
    fi

    # Clean SPM caches
    if [[ "$DEEP_CLEAN" == "true" || "$SPM_CACHE_ONLY" == "true" ]]; then
        local spm_cache="$HOME/Library/Caches/org.swift.swiftpm"
        clean_directory "$spm_cache" "SPM cache"

        local spm_cache2="$HOME/Library/Developer/Xcode/DerivedData/ModuleCache.noindex"
        clean_directory "$spm_cache2" "Module cache"
    fi

    # Clean Xcode archives (only with deep clean)
    if [[ "$DEEP_CLEAN" == "true" ]]; then
        local archives="$HOME/Library/Developer/Xcode/Archives"
        clean_directory "$archives" "Xcode archives"
    fi

    echo ""
}

# Show summary
show_summary() {
    print_info "═══════════════════════════════════════════════════"

    if [[ "$DRY_RUN" == "true" ]]; then
        print_info "Dry run completed"
        echo ""
        echo "Would save: $(format_size $TOTAL_SPACE_SAVED)"
        echo ""
        echo "Run without --dry-run to actually clean"
    else
        print_success "Cleaning completed!"
        echo ""
        echo "Space saved: $(format_size $TOTAL_SPACE_SAVED)"
    fi

    print_info "═══════════════════════════════════════════════════"
    echo ""
}

# Main execution
main() {
    print_info "═══════════════════════════════════════════════════"
    print_info "Swift Project Cleaner"
    if [[ "$DRY_RUN" == "true" ]]; then
        print_warning "DRY RUN MODE - No files will be deleted"
    fi
    print_info "═══════════════════════════════════════════════════"
    echo ""

    if [[ "$DERIVED_DATA_ONLY" == "true" || "$SPM_CACHE_ONLY" == "true" ]]; then
        # Clean global caches only
        clean_global_caches
    elif [[ "$CLEAN_ALL" == "true" ]]; then
        # Clean all projects in tree
        clean_all_projects
        if [[ "$DEEP_CLEAN" == "true" ]]; then
            clean_global_caches
        fi
    else
        # Clean single project
        clean_project "$PROJECT_PATH"
        if [[ "$DEEP_CLEAN" == "true" ]]; then
            clean_global_caches
        fi
    fi

    show_summary
}

# Run main
main
